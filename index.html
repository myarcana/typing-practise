<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Typing Tutor</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Sans+Mono%7CMontserrat:800%7CRubik:300,400,700%7CRoboto+Mono:400" media="all">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .github-corner {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1000;
        }
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }
        @keyframes octocat-wave {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(-25deg); }
            40%, 80% { transform: rotate(10deg); }
        }
        @media (max-width: 500px) {
            .github-corner:hover .octo-arm {
                animation: none;
            }
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 900px;
        }

        .input-section {
            margin-bottom: 30px;
            vertical-align: middle;
        }

        .filter-buttons {
            display: inline-flex;
            float: right;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            color: #555;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .filter-btn.disabled {
            filter: grayscale(90%);
        }

        .input-section > label {
            display: inline-block;
            float: left;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        .input-section .flags {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: sans-serif;
            cursor: pointer;
            margin-top: 10px;
        }

        .input-section .flags label {
            cursor: pointer;
            color: #555;
        }

        .character-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            font-family: "Courier New", monospace;
            transition: border-color 0.3s ease;
        }

        .character-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .timer-display {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }
        .timer-main {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .timer-hundredths {
            font-size: 1.2em;
            color: #8b9dc3;
        }

        .typing-area {
            background: #fff;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 120px;
            display: flex;
            align-items: center;
            position: relative;
            transition: border-color 0.3s ease;
        }

        .typing-area:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .typing-text {
            font-family: "Droid Sans Mono", monospace;
            color: #6c757d;
            font-size: 1.8em;
            line-height: 1.6;
            letter-spacing: 2px;
            width: 100%;
            position: relative;
        }

        .char {
            position: relative;
            display: inline-block;
            padding: 0;
            border-radius: 4px;
            margin: 1px;
            transition: all 0.2s ease;
        }

        .char.correct {
            background-color: #d4edda;
            color: #155724;
        }

        .char.incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }

        .char.corrected {
            background-color: #fff3cd;
            color: #856404;
        }

        .char.current::after {
            content: "";
            height: 100%;
            width: 100%;
            position: absolute;
            box-sizing: border-box;
            top: 0;
            left: 0;
            border-radius: 0;
            border-bottom: 4px solid #ccc;
        }

        .hidden-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .instructions {
            text-align: center;
            color: #6c757d;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .restart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 0 auto;
            display: block;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .keyboard-and-hands {
            position: relative;
            pointer-events: none;
            width: 685px;
            margin: 0 auto;
        }

        #fingers-svg {
            position: absolute;
            height: 363px;
            width: 685px;
            top: -10px;
            left: 0px;
            opacity: 0.8;
            transform: translateX(55px) scale(1.55);
        }
    </style>
</head>
<body>
    <a class="github-corner" href="https://github.com/myarcana/typing-practise" aria-label="View on GitHub">
        <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; right: 0; border: 0;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>
    <div class="container">
        <div class="input-section">
            <label for="characterSet">Character Set</label>
            <span class="filter-buttons">
                <button class="filter-btn active" id="filter-numbers">Number keys</button>
                <button class="filter-btn" id="filter-shift">Shift</button>
                <button class="filter-btn" id="filter-letters">Letter keys</button>
                <button class="filter-btn" id="filter-symbols">Symbol keys</button>
                <button class="filter-btn active" id="filter-lefthand">Left hand</button>
                <button class="filter-btn active" id="filter-righthand">Right hand</button>
            </span>
            <input
                type="text"
                id="characterSet"
                name="characterSet"
                class="character-input"
                rows="3"
                placeholder="Enter the characters you want to practice (e.g., abcdefghijklmnopqrstuvwxyz or asdf jkl;)"
                onkeyup="generateNewLine()"
                value="0123456789"
            >
            <div class="flags">
                <input type="checkbox" id="proceedOnError" name="proceedOnError">
                <label for="proceedOnError">Proceed on error</label>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <span class="stat-value" id="wpm">0</span>
                <div class="stat-label">WPM</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="accuracy">100%</span>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="timer-display">
                    <span class="timer-main" id="timer-main">0:00</span>
                    <span class="timer-hundredths" id="timer-hundredths">.00</span>
                </div>
                <div class="stat-label">Time</div>
            </div>
        </div>

        <div class="typing-area" onclick="focusInput()">
            <div class="typing-text" id="typingText"></div>
            <input type="text" class="hidden-input" id="typingInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>

        <div class="keyboard-and-hands">
            <object id="keyboard-svg" data="./keyboard.svg" type="image/svg+xml">
                SVG not loading.
            </object>
            <object id="fingers-svg" data="./hands.svg" type="image/svg+xml">
                SVG not loading.
            </object>
        </div>
    </div>

    <script>
        let lessonText = '';
        let currentPosition = 0;
        let isTypingStarted = false;
        let updateStatsInterval;
        let startTime = null;
        let elapsed = null;
        let lastValue = '';

        const typingInput = document.getElementById('typingInput');
        const typingTextElement = document.getElementById('typingText');

        let keyboardSvg;
        let fingersSvg;

        const lettersOnKeys = {
            "`": ["`", "~"],
            "~": ["`", "~"],
            "1": ["1", "!"],
            "!": ["1", "!"],
            "2": ["2", "@"],
            "@": ["2", "@"],
            "3": ["3", "#"],
            "#": ["3", "#"],
            "4": ["4", "$"],
            "$": ["4", "$"],
            "5": ["5", "%"],
            "%": ["5", "%"],
            "6": ["6", "^"],
            "^": ["6", "^"],
            "7": ["7", "&"],
            "&": ["7", "&"],
            "8": ["8", "*"],
            "*": ["8", "*"],
            "9": ["9", "("],
            "(": ["9", "("],
            "0": ["0", ")"],
            ")": ["0", ")"],
            "-": ["-", "_"],
            "_": ["-", "_"],
            "=": ["=", "+"],
            "+": ["=", "+"],
            "q": ["q", "Q"],
            "Q": ["q", "Q"],
            "w": ["w", "W"],
            "W": ["w", "W"],
            "e": ["e", "E"],
            "E": ["e", "E"],
            "r": ["r", "R"],
            "R": ["r", "R"],
            "t": ["t", "T"],
            "T": ["t", "T"],
            "y": ["y", "Y"],
            "Y": ["y", "Y"],
            "u": ["u", "U"],
            "U": ["u", "U"],
            "i": ["i", "I"],
            "I": ["i", "I"],
            "o": ["o", "O"],
            "O": ["o", "O"],
            "p": ["p", "P"],
            "P": ["p", "P"],
            "[": ["[", "{"],
            "{": ["[", "{"],
            "]": ["]", "}"],
            "}": ["]", "}"],
            "\\": ["\\", "|"],
            "|": ["\\", "|"],
            "a": ["a", "A"],
            "A": ["a", "A"],
            "s": ["s", "S"],
            "S": ["s", "S"],
            "d": ["d", "D"],
            "D": ["d", "D"],
            "f": ["f", "F"],
            "F": ["f", "F"],
            "g": ["g", "G"],
            "G": ["g", "G"],
            "h": ["h", "H"],
            "H": ["h", "H"],
            "j": ["j", "J"],
            "J": ["j", "J"],
            "k": ["k", "K"],
            "K": ["k", "K"],
            "l": ["l", "L"],
            "L": ["l", "L"],
            ";": [";", ":"],
            ":": [";", ":"],
            "'": ["'", "\""],
            "\"": ["'", "\""],
            "z": ["z", "Z"],
            "Z": ["z", "Z"],
            "x": ["x", "X"],
            "X": ["x", "X"],
            "c": ["c", "C"],
            "C": ["c", "C"],
            "v": ["v", "V"],
            "V": ["v", "V"],
            "b": ["b", "B"],
            "B": ["b", "B"],
            "n": ["n", "N"],
            "N": ["n", "N"],
            "m": ["m", "M"],
            "M": ["m", "M"],
            ",": [",", "<"],
            "<": [",", "<"],
            ".": [".", ">"],
            ">": [".", ">"],
            "/": ["/", "?"],
            "?": ["/", "?"]
        };

        const keyCombinations = {
            "a": ["a", "neutral-right"],
            "b": ["b", "neutral-right"],
            "c": ["c", "neutral-right"],
            "d": ["d", "neutral-right"],
            "e": ["e", "neutral-right"],
            "f": ["f", "neutral-right"],
            "g": ["g", "neutral-right"],
            "h": ["h", "neutral-left"],
            "i": ["i", "neutral-left"],
            "j": ["j", "neutral-left"],
            "k": ["k", "neutral-left"],
            "l": ["l", "neutral-left"],
            "m": ["m", "neutral-left"],
            "n": ["n", "neutral-left"],
            "o": ["o", "neutral-left"],
            "p": ["p", "neutral-left"],
            "q": ["q", "neutral-right"],
            "r": ["r", "neutral-right"],
            "s": ["s", "neutral-right"],
            "t": ["t", "neutral-right"],
            "u": ["u", "neutral-left"],
            "v": ["v", "neutral-right"],
            "w": ["w", "neutral-right"],
            "x": ["x", "neutral-right"],
            "y": ["y", "neutral-left"],
            "z": ["z", "neutral-right"],
            "0": ["key-0", "neutral-left"],
            "1": ["key-1", "neutral-right"],
            "2": ["key-2", "neutral-right"],
            "3": ["key-3", "neutral-right"],
            "4": ["key-4", "neutral-right"],
            "5": ["key-5", "neutral-right"],
            "6": ["key-6", "neutral-left"],
            "7": ["key-7", "neutral-left"],
            "8": ["key-8", "neutral-left"],
            "9": ["key-9", "neutral-left"],
            "!": ["shift-right", "key-1", "text-shift-right"],
            "@": ["shift-right", "key-2", "text-shift-right"],
            "#": ["shift-right", "key-3", "text-shift-right"],
            "$": ["shift-right", "key-4", "text-shift-right"],
            "%": ["shift-right", "key-5", "text-shift-right"],
            "^": ["shift-left", "key-6", "text-shift-left"],
            "&": ["shift-left", "key-7", "text-shift-left"],
            "*": ["shift-left", "key-8", "text-shift-left"],
            "(": ["shift-left", "key-9", "text-shift-left"],
            ")": ["shift-left", "key-0", "text-shift-left"],
            "-": ["minus", "neutral-right"],
            "_": ["shift-left", "minus", "text-shift-left"],
            "=": ["equal", "neutral-left"],
            "+": ["shift-left", "equal", "text-shift-left"],
            "[": ["open-bracket", "neutral-left"],
            "{": ["shift-left", "open-bracket", "text-shift-left"],
            "]": ["close-bracket", "neutral-left"],
            "}": ["shift-left", "close-bracket", "text-shift-left"],
            "\\": ["backslash", "neutral-left"],
            "|": ["shift-left", "backslash", "text-shift-left"],
            ";": ["semicolon", "neutral-left"],
            ":": ["shift-left", "semicolon", "text-shift-left"],
            "'": ["quote", "neutral-left"],
            "\"": ["shift-left", "quote", "text-shift-left"],
            ",": ["comma", "neutral-right"],
            "<": ["shift-left", "comma", "text-shift-left"],
            ".": ["dot", "neutral-left"],
            ">": ["shift-left", "dot", "text-shift-left"],
            "/": ["slash", "neutral-left"],
            "?": ["shift-left", "slash", "text-shift-left"],
            "`": ["tilda", "neutral-right"],
            "~": ["shift-left", "tilda", "text-shift-left"],
            " ": ["space", "neutral-left", "text-space"],
            "\n": ["enter", "neutral-left", "text-enter"],
            "\t": ["tab", "neutral-left", "text-tab"],
            "A": ["shift-right", "a", "text-shift-right"],
            "B": ["shift-left", "b", "text-shift-left"],
            "C": ["shift-left", "c", "text-shift-left"],
            "D": ["shift-right", "d", "text-shift-right"],
            "E": ["shift-right", "e", "text-shift-right"],
            "F": ["shift-right", "f", "text-shift-right"],
            "G": ["shift-right", "g", "text-shift-right"],
            "H": ["shift-left", "h", "text-shift-left"],
            "I": ["shift-left", "i", "text-shift-left"],
            "J": ["shift-left", "j", "text-shift-left"],
            "K": ["shift-left", "k", "text-shift-left"],
            "L": ["shift-left", "l", "text-shift-left"],
            "M": ["shift-left", "m", "text-shift-left"],
            "N": ["shift-left", "n", "text-shift-left"],
            "O": ["shift-left", "o", "text-shift-left"],
            "P": ["shift-left", "p", "text-shift-left"],
            "Q": ["shift-right", "q", "text-shift-right"],
            "R": ["shift-right", "r", "text-shift-right"],
            "S": ["shift-right", "s", "text-shift-right"],
            "T": ["shift-right", "t", "text-shift-right"],
            "U": ["shift-left", "u", "text-shift-left"],
            "V": ["shift-right", "v", "text-shift-right"],
            "W": ["shift-right", "w", "text-shift-right"],
            "X": ["shift-right", "x", "text-shift-right"],
            "Y": ["shift-left", "y", "text-shift-left"],
            "Z": ["shift-right", "z", "text-shift-right"]
        };

        function generateRandomString(chars, length = 35) {
            let result = '';
            if (chars) {
                for (let i = 0; i < length; i++) {
                    result += chars[Math.floor(Math.random() * chars.length)];
                }
            }
            return result;
        }

        function generateNewLine() {
            const characterSet = document.getElementById('characterSet').value;

            clearInterval(updateStatsInterval);

            lessonText = generateRandomString(characterSet);
            currentPosition = 0;
            isTypingStarted = false;
            startTime = null;
            elapsed = null;

            fillTypingText();
            moveCursorTo(0);
            typingInput.value = '';
            lastValue = '';
        }

        function moveCursorTo(currentPosition) {
            typingTextElement.querySelectorAll('.char').forEach(charElem => charElem.classList.remove('current'));
            if (currentPosition < lessonText.length) {
                typingTextElement.querySelectorAll('.char')[currentPosition].classList.add('current');
            }

            fingersSvg.querySelectorAll("svg > g").forEach(el => {
                el.classList.add("st0");
            });

            keyboardSvg.querySelectorAll("svg > g > .active").forEach(el => {
                el.classList.remove("active");
            });

            if (currentPosition < lessonText.length) {
                const nextChar = lessonText[currentPosition];
                const combo = keyCombinations[nextChar];

                if (combo) {
                    combo.forEach(id => {
                        const finger = fingersSvg.querySelector(`#${id}`);
                        if (finger) {
                            finger.classList.remove("st0");
                        }
                        const key = keyboardSvg.querySelector(`#${id}`);
                        if (key) {
                            key.classList.add("active");
                        }
                    });
                }

                const lettersOnKey = lettersOnKeys[nextChar];
                if (lettersOnKey) {
                    const keyboardLetters = keyboardSvg.querySelectorAll(`svg > g > text`).forEach(elem => {
                        if (lettersOnKey.includes(elem.textContent)) {
                            elem.classList.add("active");
                        }
                    });
                }
            } else {
                ['neutral-left', 'enter'].forEach(id => {
                    const finger = fingersSvg.querySelector(`#${id}`);
                    if (finger) {
                        finger.classList.remove("st0");
                    }
                });
                ['enter', 'text-enter'].forEach(id => {
                    keyboardSvg.querySelector(`svg #${id}`).classList.add('active');
                });
            }
        }

        function fillTypingText() {
            let html = '';
            for (let i = 0; i < lessonText.length; i++) {
                const char = lessonText[i];
                if (char === ' ') {
                    html += `<span class="char">&nbsp;</span>`;
                } else {
                    html += `<span class="char">${char}</span>`;
                }
            }
            typingTextElement.innerHTML = html;
        }

        function updateStats() {
            const correctChars = document.querySelectorAll('.char.correct').length;
            const totalChars = currentPosition;
            const accuracy = totalChars > 0 ? correctChars / totalChars : 100;
            if (startTime) {
                elapsed = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const hundredths = Math.floor((elapsed % 1000) / 10);
                document.getElementById('timer-main').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timer-hundredths').textContent = 
                    `.${hundredths.toString().padStart(2, '0')}`;

                const fractionalMinutes = elapsed / 1000 / 60;
                const cpm = correctChars / fractionalMinutes;
                wpm = Math.round(cpm / 5);
                document.getElementById('wpm').textContent = wpm;
            } else {
                document.getElementById('wpm').textContent = "0";
                document.getElementById('timer-main').textContent = "00:00";
                document.getElementById('timer-hundredths').textContent = "00";
            }
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function completeCurrentLine() {
            clearInterval(updateStatsInterval);
            updateStats();
        }

        function focusInput() {
            typingInput.focus();
        }

        function restartTyping() {
            currentPosition = 0;
            isTypingStarted = false;
            startTime = null;
            elapsed = null;
            lastValue = '';
            typingInput.value = '';
            clearInterval(updateStatsInterval);
            fillTypingText();
            moveCursorTo(0);
            updateStats();
            focusInput();
        }

        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (typingInput.value.length === 0) {
                    generateNewLine();
                } else {
                    restartTyping();
                }
                return;
            }

            if (e.keyCode >= 37 && e.keyCode <= 40) {
                e.preventDefault(); // arrow keys
                return;
            }

            if (currentPosition > lessonText.length && e.key !== 'Backspace') {
                e.preventDefault(); // prevent typing past end
                return;
            }
        });

        typingInput.addEventListener('input', (e) => {
            const newValue = typingInput.value;
            let key;

            if (newValue.length < lastValue.length) {
                key = 'Backspace';
            } else if (newValue.length > lastValue.length) {
                key = newValue.at(-1);
            } else {
                lastValue = newValue;
                return;
            }

            if (!isTypingStarted) {
                isTypingStarted = true;
                startTime = Date.now();
                updateStatsInterval = setInterval(updateStats, 20);
            }

            // Determine the current position
            if (key === 'Backspace') {
                currentPosition = Math.max(0, currentPosition - 1);
            } else {
                currentPosition++;
            }

            moveCursorTo(currentPosition);

            // Clear classes for current position (in case of backspace)
            if (currentPosition < lessonText.length) {
                typingTextElement.querySelectorAll('.char')[currentPosition].classList.remove('incorrect', 'correct');
            }

            // Highlight last typed character (skip if backspace)
            if (key !== 'Backspace' && currentPosition > 0) {
                const lastChar = key;
                const lastCharElem = typingTextElement.querySelectorAll('.char')[currentPosition - 1];
                const tempKeyboardKeyClasses = [];

                if (lastChar === lessonText[currentPosition - 1]) {
                    lastCharElem.classList.add('correct');
                    tempKeyboardKeyClasses.push('correct');
                } else {
                    if (document.getElementById('proceedOnError').checked) {
                        lastCharElem.classList.add('incorrect');
                    } else {
                        e.preventDefault();
                        currentPosition--;
                        moveCursorTo(currentPosition);
                    }
                    tempKeyboardKeyClasses.push('incorrect');
                }

                // Highlight keyboard keys
                const combos = keyCombinations[lastChar];
                if (combos) {
                    combos.forEach(id => {
                        const key = keyboardSvg.querySelector(`#keys #${id}`);
                        if (key) {
                            key.classList.add(...tempKeyboardKeyClasses);
                            setTimeout(() => key.classList.remove(...tempKeyboardKeyClasses), 200);
                        }
                    });
                }
            }

            if (currentPosition >= lessonText.length) {
                completeCurrentLine();
            }

            lastValue = newValue;
        });

        var fingersSvgReady = new Promise(function(resolve) {
            document.getElementById("fingers-svg").addEventListener("load", resolve, true);
        });
        var keyboardSvgReady = new Promise(function(resolve) {
            document.getElementById("keyboard-svg").addEventListener("load", resolve, true);
        });
        Promise.all([fingersSvgReady, keyboardSvgReady]).then(function() {
            keyboardSvg = document.getElementById("keyboard-svg").contentDocument;
            fingersSvg = document.getElementById("fingers-svg").contentDocument;
            generateNewLine();
            focusInput();
        });

        const filterSets = {
            'filter-numbers': '1234567890!@#$%^&*()',
            'filter-lefthand': 'qwertasdfgzxcvb`12345QWERTASDFGZXCVB~',
            'filter-righthand': String.raw`yuiophjklnm67890-=[]\;',./YUIOPHJKLNM^&*()_+{}|:"<>?`,
            'filter-shift': '!@#$%^&*()_+QWERTYUIOP{}ASDFGHJKL:"|~ZXCVBNM<>?',
            'filter-letters': 'qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM',
            'filter-symbols': '`-=[]\\;\',\./~_+{}|:"<>?'
        };

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                setFilterButtons(true);
                updateCharacterSetFromFilters();
            });
        });

        document.getElementById('characterSet').addEventListener('input', (e) => {
            setFilterButtons(false);
        });

        function updateCharacterSetFromFilters() {
            const notActiveFilters = document.querySelectorAll('.filter-btn:not(.active)');
            let chars = new Set(Object.keys(lettersOnKeys));
            notActiveFilters.forEach(btn => {
                const notAllowedString = filterSets[btn.id];
                if (notAllowedString) {
                    const notAllowedChars = new Set([...notAllowedString]);
                    chars = chars.difference(notAllowedChars);
                }
            });
            const characterInput = document.getElementById('characterSet');
            characterInput.value = Array.from(chars).join('');
            generateNewLine();
        }

        function setFilterButtons(enabled) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (enabled) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('character-input') &&
                !e.target.classList.contains('generate-btn') &&
                !e.target.classList.contains('restart-btn')) {
                setTimeout(focusInput, 100);
            }
        });
    </script>
</body>
</html>
